WANIP1 alias using LAN ip 10.122.0.39 and needs to use WANIP of 10.122.0.7



Step 1: 
Run this to accept FreEBSd 12 image in subscription: 
az login --service-principal --username "1cd8eb1b-52fd-4f4f-8be1-8fdf9089872f" --password "PVN0raj~vuWrBBNfzuaM4l0~YI9DStXSfz" --tenant "372ee9e0-9ce0-4033-a64a-c07073a91ecd"
az account set --subscription "0d1caf51-ae4d-4867-b90e-ce93782cd9b2"
az vm image terms accept --subscription "0d1caf51-ae4d-4867-b90e-ce93782cd9b2" --urn "thefreebsdfoundation:freebsd-12_2:12_2-release:12.2.0"


no need for this: az vm image terms accept --subscription "367b68e8-7a71-46ee-8c43-f5488498ed9e" --urn  "RedHat:RHEL:7-RAW:latest"


Step 2: Run Terraform with new config ( I sent you zip ) 

Step 3: Install FW using below as example

# fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/opnsense-bootstrap.sh
# fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/config.xml
# fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/pw.php
# fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips.sh
# fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips2.sh
# fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips3.sh
# sh ./opnsense-bootstrap.sh -y
# sh ./updateips.sh <wanip> <wansubnet-cidr> <lanip> <lansubnet-cidr> <langw-ip> <wangw-ip> <backendnet> <backendnet-cidr>
# sh ./updateips2.sh <mgmtnet> <mgmtnet-cidr> <wanip2-alias-vip> <wanip3-alias-vip> <ovpntunnet> <ovpntunnet-cidr> <ovpnlocnet> <ovpnlocnet-cidr>
# sh ./updateips3.sh <gatewaynet> <gatewaynet-cidr> <azurep2snet> <azurep2snet-cidr> <fwpw> <oxidizedpw>
# cp config.xml /usr/local/etc/config.xml
# reboot

Firewall #1: 

fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/opnsense-bootstrap.sh
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/pw.php
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/config.xml
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips.sh
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips2.sh
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips3.sh
sh ./opnsense-bootstrap.sh -y
sh ./updateips.sh 10.122.0.7 27 10.122.0.39 27 10.122.0.33 10.122.0.1 10.122.0.32 27 
sh ./updateips2.sh 10.122.0.64 26 10.122.0.9 10.122.0.11 172.31.122.0 24 10.122.0.0 24
sh ./updateips3.sh 10.122.0.128 26 172.17.122.0 24 4Y4qphauPflcarg610Bt jJVoAWEbgeeAqT9flN29
cp config.xml /usr/local/etc/config.xml
reboot


Firewall #2:

fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/opnsense-bootstrap.sh
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/pw.php
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/config.xml
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips.sh
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips2.sh
fetch https://raw.githubusercontent.com/wjwidener/update/master/bootstrap/updateips3.sh
sh ./opnsense-bootstrap.sh -y
sh ./updateips.sh 10.122.0.8 27 10.122.0.40 27 10.122.0.33 10.122.0.1 10.122.0.32 27 
sh ./updateips2.sh 10.122.0.64 26 10.122.0.10 10.122.0.12 172.31.122.0 24 10.122.0.0 24
sh ./updateips3.sh 10.122.0.128 26 172.18.122.0 24 4Y4qphauPflcarg610Bt jJVoAWEbgeeAqT9flN29
cp config.xml /usr/local/etc/config.xml
reboot

ssh to firewall and autoinstall os-api-backup and os-node_exporter
echo "y" | pkg install os-api-backup-1.0
echo "y" | pkg install os-node_exporter-1.0


static routes: 
    <route uuid="c1f0ff30-ebf5-472e-907a-4fbcdd830381">
      <network>10.122.0.128/26</network>
      <gateway>LAN_GW</gateway>
      <descr>Gateway Subnet</descr>
      <disabled>0</disabled>
    </route>

NAT: 




Step 4: 
Install RedHat IdM as normal


echo '4Y4qphauPflcarg610Bt' | kinit admin

./newuser bob GSEC.HASOPS.COM abcdef vMUOxPf5EyCocloPL2XB Bob User 4Y4qphauPflcarg610Bt vpnsvc
./newuser alice GSEC.HASOPS.COM abcdef vMUOxPf5EyCocloPL2XB Bob User 4Y4qphauPflcarg610Bt vpnsvcadmin


User Certs for ipa:


openssl req -nodes -newkey rsa:2048 -keyout bob.gsec.hasops.com.key -out bob.gsec.hasops.com.csr -subj "/C=US/ST=GA/L=Atlanta/O=GSEC.HASOPS.COM/CN=bob"
ipa cert-request --principal bob@GSEC.HASOPS.COM --ca ipa /root/certs2/bob.gsec.hasops.com.csr
ipa cert-show 43 --ca=ipa --certificate-out=bob.gsec.hasops.com.crt
openssl pkcs12 -export -out bob.gsec.hasops.com.pfx -inkey bob.gsec.hasops.com.key -in bob.gsec.hasops.com.crt -certfile ca-root-sec-hasops-com.crt

openssl req -nodes -newkey rsa:2048 -keyout alice.gsec.hasops.com.key -out alice.gsec.hasops.com.csr -subj "/C=US/ST=GA/L=Atlanta/O=GSEC.HASOPS.COM/CN=alice"
ipa cert-request --principal alice@GSEC.HASOPS.COM --ca ipa /root/certs2/alice.gsec.hasops.com.csr
ipa cert-show 43 --ca=ipa --certificate-out=alice.gsec.hasops.com.crt
openssl pkcs12 -export -out alice.gsec.hasops.com.pfx -inkey alice.gsec.hasops.com.key -in alice.gsec.hasops.com.crt -certfile ca-root-sec-hasops-com.crt

create SSH pub key for bob and alice: 

***** Newer versions of OpenSSL say BEGIN PRIVATE KEY because they contain the private key + an OID that identifies the key type (this is known as PKCS8 format). 
***** To get the old style key (known as either PKCS1 or traditional OpenSSL format) you can do this:
*****
*****	openssl rsa -in server.key -out server_ssh.key
***** 
***** Alternately, if you have a PKCS1 key and want PKCS8:
*****
*****	openssl pkcs8 -topk8 -nocrypt -in server_ssh.key
*****	
***** Then to save the key in an OpenSSH format: 
*****
*****   ssh-keygen -y -f server_ssh.key > server_ssh.pub
*****
 

cd /root/certs2

chmod 600 bob.gsec.hasops.com.key
openssl rsa -in bob.gsec.hasops.com.key -out bob.gsec.hasops.com.SSH.key
ssh-keygen -y -f bob.gsec.hasops.com.SSH.key > bob.gsec.hasops.com.pub

chmod 600 alice.gsec.hasops.com.key
openssl rsa -in alice.gsec.hasops.com.key -out alice.gsec.hasops.com.SSH.key
ssh-keygen -y -f alice.gsec.hasops.com.SSH.key > alice.gsec.hasops.com.pub


User Certs for vpn:

openssl req -nodes -newkey rsa:2048 -keyout bob.gsec.hasops.com.key -out bob.gsec.hasops.com.csr -subj "/C=US/ST=GA/L=Atlanta/O=GSEC.HASOPS.COM/CN=bob"
ipa cert-request --principal bob@GSEC.HASOPS.COM --ca esvpn /root/certs2/bob.gsec.hasops.com.csr
ipa cert-show 20 --ca=esvpn --certificate-out=bob.gsec.hasops.com.crt
cp ca-intermediate-devopsvpnca-gsec-hasops-com.crt ca-chain.crt
cat ca-root-gsec-hasops-com.crt >> ca-chain.crt
openssl pkcs12 -export -out bob.gsec.hasops.com.pfx -inkey bob.gsec.hasops.com.key -in bob.gsec.hasops.com.crt -certfile ca-chain.crt

openssl req -nodes -newkey rsa:2048 -keyout alice.gsec.hasops.com.key -out alice.gsec.hasops.com.csr -subj "/C=US/ST=GA/L=Atlanta/O=GSEC.HASOPS.COM/CN=alice"
ipa cert-request --principal alice@GSEC.HASOPS.COM --ca esvpn /root/certs2/alice.gsec.hasops.com.csr
ipa cert-show 20 --ca=esvpn --certificate-out=alice.gsec.hasops.com.crt
cp ca-intermediate-devopsvpnca-gsec-hasops-com.crt ca-chain.crt
cat ca-root-gsec-hasops-com.crt >> ca-chain.crt
openssl pkcs12 -export -out alice.gsec.hasops.com.pfx -inkey alice.gsec.hasops.com.key -in alice.gsec.hasops.com.crt -certfile ca-chain.crt

Host Certs for ipa:


Add HAProxy Load Balancer 
secops-gsec-amr-haproxylb
Add Traffic Manager Profile